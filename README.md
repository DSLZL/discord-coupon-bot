# Discord 兑换券机器人 (v2.0)

这是一个融合了社区智慧与原创功能的重大更新版本。

### 项目背景

本项目在原有功能的基础上，审查并采纳了一个来自社区贡献 (Pull Request) 的现代化后端架构。该架构引入了基于 `config.yml` 的模块化加载、更安全的基于用户ID的权限系统，以及更清晰的代码结构。

在此先进架构之上，我们重新整合并优化了原有的全部核心功能，包括：
- **丰富的功能**: 兑换券有效期、`.zip` 文件上传、数据库自动备份、系统状态查询等。
- **稳健的持久化**: 确保数据和备份在容器重建后依然安全。

最终，我们打造出这个功能更强大、架构更稳健、配置更灵活的 v2.0 版本，旨在提供一个顶级的 Discord 兑换券管理机器人。

## ✨ 功能特性

- **多项目管理**: 可同时创建和管理多个独立的兑换券项目。
- **灵活的兑换券系统**:
  - 管理员可通过上传 `.txt` 或 `.zip` 文件批量添加兑换券。
  - 可为每批兑换券设置**有效期**。
  - 自动防止重复的兑换券被添加。
- **完善的用户申领流程**:
  - 用户可通过 `/申领` 命令获取兑换券，并看到其有效期。
  - 可通过 `/库存` 命令查询项目剩余的、未过期的兑换券数量。
- **强大的权限与设置**:
  - 基于**用户 ID** 的管理员权限系统，安全可靠。
  - 可为每个项目独立**开启/关闭**申领功能。
  - 可为每个项目独立设置**申领冷却时间**。
- **用户管理与审核**:
  - 管理员可对用户进行**全局**或**项目级**的封禁/解封。
  - 可设置封禁时长，支持永久封禁。
- **为生产环境设计**:
  - 使用 `SQLAlchemy` 和 `aiosqlite` 进行高效、异步的数据库操作。
  - 包含**数据库自动备份**和**过期券自动清理**的后台任务。
  - 包含自动重连逻辑，确保机器人稳定运行。
  - 提供 `Dockerfile` 和 `docker-compose.yml`，支持一键式容器化部署。
  - 支持通过环境变量将命令限定在**指定服务器**注册，避免对非开发服务器的干扰。
- **系统状态监控**:
  - 可通过 `/状态` 命令查看机器人核心指标、硬件占用及 API 连接状态。

---

## 🚀 快速开始

### 先决条件

- [Docker](https://www.docker.com/get-started) 和 [Docker Compose](https://docs.docker.com/compose/install/)
- 一个 Discord 机器人账号并获取其 **Token**
- 您自己的 Discord **用户 ID**

### 安装与配置

1.  **克隆或下载此项目**
    ```bash
    git clone https://github.com/your-username/discord-coupon-bot.git
    cd discord-coupon-bot
    ```

2.  **创建并配置 `.env` 文件**
    - 复制 `.env.example` 文件并重命名为 `.env`。
    - 打开 `.env` 文件并填入您的信息：
      ```env
      # (必需) 您的 Discord 机器人令牌
      DISCORD_BOT_TOKEN="在此处粘贴您的机器人令牌"

      # (必需) 机器人管理员的用户ID。只有这些用户能使用管理命令。
      # 可以添加多个ID，用英文逗号 (,) 分隔。
      ADMIN_USER_IDS="在此处粘贴您的用户ID"

      # (推荐) 信任的服务器ID。如果设置此ID，命令将只在该服务器上即时注册。
      # 可以添加多个ID，用英文逗号 (,) 分隔。
      TRUSTED_GUILD_ID="在此处粘贴您的服务器ID"
      
      # (可选) 星星人民公益站 API 配置, 用于 /状态 命令
      # OPENAI_API_BASE="在此处粘贴API端点"
      # OPENAI_API_KEY="在此处粘贴API密钥"
      # OPENAI_MODEL_NAME="在此处粘贴模型名称"
      ```
    - **如何获取用户/服务器 ID**: 在 Discord 中，右键点击用户头像或服务器图标，选择“复制ID”。(您可能需要在 用户设置 > 高级 中开启“开发者模式”)

3.  **创建数据和备份目录**
    在项目根目录下运行以下命令，以确保数据能够正确地持久化。
    ```bash
    mkdir data
    mkdir backups
    ```

4.  **使用 Docker Compose 启动机器人**
    在项目根目录下运行以下命令：
    ```bash
    docker-compose up -d --build
    ```
    这将会构建镜像并在后台启动机器人。

5.  **查看日志** (可选)
    如果您想确认机器人是否成功启动，可以运行：
    ```bash
    docker-compose logs -f
    ```
    当您看到 `所有后台任务已成功启动` 时，表示机器人已准备就绪。

---

## 🤖 命令列表

### 普通用户命令

- **`/库存 [项目]`**
  - 查询指定项目的可用兑换券数量。消息在10秒后会自动删除。
- **`/申领 [项目]`**
  - 从指定的项目申领一张兑换券。机器人会将兑换券代码和有效期通过一条仅您可见的消息发送给您。
- **`/状态`**
  - 查看机器人和服务器的运行状态。消息在10秒后会自动删除。

### 管理员命令 (需要您的用户ID在`.env`的`ADMIN_USER_IDS`中)

所有管理员命令都在 `/管理` 命令组下。

- **`/管理 创建项目 [名称]`**
- **`/管理 删除项目 [项目]`** (危险操作)
- **`/管理 添加兑换券 [项目] [文件] [有效期(可选)]`**
  - `文件`: 支持 `.txt` 或 `.zip` 文件。
  - `有效期`: 兑换券的有效天数（例如 `30`）。如果留空，则为永久。
- **`/管理 开关申领 [项目] [状态]`**
- **`/管理 设置冷却 [项目] [小时]`**
- **`/管理 封禁 [用户] [原因] [项目(可选)] [时长(可选)]`**
- **`/管理 解封 [用户] [原因] [项目(可选)]`**

---

## 📜 许可证 (License)

本项目采用 **[Apache-2.0 with Commons Clause](LICENSE)** 许可协议。

<details>
<summary><strong>点击展开/折叠 许可证摘要</strong></summary>

### Commons Clause (公共条款) 摘要
**核心限制：禁止销售**
在不限制 Apache 2.0 许可证中其他条件的情况下，本授权**不包含**，也**未授予**您**“销售”**本软件的权利。
“销售”是指为了获取费用或其他对价，向第三方提供其价值完全或主要源于本软件功能的产品或服务。

### Apache 2.0 许可证摘要
这是一个宽松的开源软件许可证，允许您自由使用、分发和修改本软件，但您必须保留原始的版权声明和许可证文件。本软件按“原样”提供，不附带任何保证。

</details>