# Discord 兑换券机器人

> **当前版本:** 1.0.0

一个功能强大且易于部署的 Discord 机器人，用于管理、分发和跟踪多个项目的兑换券。

## ✨ 功能特性

- **多项目管理**: 可同时创建和管理多个独立的兑换券项目。
- **灵活的兑换券系统**:
  - 管理员可通过上传单个 `.txt` 文件或包含多个 `.txt` 文件的 `.zip` 压缩包来批量添加兑换券。
  - 可为兑换券设置有效期。
  - 自动防止重复的兑换券被添加。
  - 自动清理过期的兑换券，保持数据库整洁。
- **完善的用户申领流程**:
  - 用户可通过 `/申领` 命令获取兑换券。
  - 通过 `/库存` 命令查询指定项目剩余的兑换券数量。
  - 申领成功或查询冷却状态时，会以人性化的相对时间（如“剩余3天”）显示有效期。
- **强大的权限与设置**:
  - 基于 Discord 角色的管理员权限系统 (默认为 "管理组" 角色)。
  - 可为每个项目独立**开启/关闭**申领功能。
  - 可为每个项目独立设置**申领冷却时间**。
- **透明的用户管理**:
  - 管理员可对用户进行**全局**或**项目级**的封禁/解封。
  - 封禁与解封操作都需要提供理由，并会在频道内进行**公开公告**，增加管理透明度。
  - 可设置封禁时长，支持永久封禁。
- **为生产环境设计**:
  - 使用 `SQLAlchemy` 和 `SQLite` 进行高效、异步的数据库操作。
  - 包含自动重连逻辑，确保机器人稳定运行。
  - 提供 `Dockerfile` 和 `docker-compose.yml`，支持一键式容器化部署。
  - 支持通过环境变量将命令限定在**指定服务器**注册，避免对非开发服务器的干扰。
- **系统监控与维护**:
  - 提供 `/状态` 命令，可查看机器人核心性能、硬件资源占用及API连通性。
  - 每日自动备份数据库，并清理旧备份。

---

## 🚀 快速开始

### 先决条件

- [Docker](https://www.docker.com/get-started) 和 [Docker Compose](https://docs.docker.com/compose/install/)
- 一个 Discord 机器人账号并获取其 **Token**
- 在您的 Discord 服务器中创建一个名为 **`管理组`** 的角色，并将其分配给您自己。

### 安装与配置

1.  **克隆或下载此项目**
    ```bash
    git clone https://github.com/your-username/discord-coupon-bot.git
    cd discord-coupon-bot
    ```

2.  **创建并配置 `.env` 文件**
    - 复制 `.env.example` 文件并重命名为 `.env`。
    - 打开 `.env` 文件并填入您的信息：
      ```env
      # 您的 Discord 机器人令牌
      DISCORD_BOT_TOKEN="在此处粘贴您的机器人令牌"

      # (推荐) 信任的服务器ID。如果设置此ID，命令将只在该服务器上即时注册。
      TRUSTED_GUILD_ID="在此处粘贴您的服务器ID"
      ```
    - **如何获取服务器 ID**: 在 Discord 中，右键点击您的服务器图标，选择“复制服务器 ID”。(您可能需要在用户设置 > 高级中开启“开发者模式”)

3.  **使用 Docker Compose 启动机器人**
    在项目根目录下运行以下命令：
    ```bash
    docker-compose up -d --build
    ```
    这将会构建镜像并在后台启动机器人。

4.  **查看日志** (可选)
    如果您想确认机器人是否成功启动，可以运行：
    ```bash
    docker-compose logs -f
    ```
    当您看到 `以 YourBotName#1234 的身份登录成功` 时，表示机器人已准备就绪。

---

## 🤖 命令列表

### 普通用户命令

- **`/库存 [项目]`**
  - 查询指定项目的可用兑换券数量。
  - `项目`: 要查询的项目名称 (有自动补全)。

- **`/申领 [项目]`**
  - 从指定的项目申领一张兑换券。
  - `项目`: 要申领的项目名称 (有自动补全)。
  - 机器人会将兑换券代码通过一条仅您可见的消息发送给您。

- **`/状态`**
  - 查看机器人当前的运行状态，包括网络延迟、资源占用等。
  - 该消息10秒后会自动删除。

### 管理员命令 (需要 `管理组` 角色)

所有管理员命令都在 `/管理` 命令组下。

- **`/管理 创建项目 [名称]`**
  - 创建一个新的兑换券项目。

- **`/管理 删除项目 [项目]`**
  - **(危险操作)** 永久删除一个项目及其所有兑换券和封禁记录。操作前会有二次确认。

- **`/管理 添加兑换券 [项目] [文件] [有效期(可选)]`**
  - 向指定项目批量添加兑换券。
  - `文件`: 一个 `.txt` 文件或一个包含多个 `.txt` 文件的 `.zip` 压缩包。
  - `有效期`: 兑换券的有效天数（例如 `10`），如果留空则永久有效。

- **`/管理 开关申领 [项目] [状态]`**
  - 为一个项目启用或禁用申领功能。
  - `状态`: `开启` 或 `关闭`。

- **`/管理 设置冷却 [项目] [小时]`**
  - 为一个项目设置申领冷却时间（单位：小时）。设置为 `0` 则无冷却。

- **`/管理 封禁 [用户] [原因] [项目(可选)] [时长(可选)]`**
  - 禁止一个用户申领兑换券。
  - `项目`: 如果留空，则为全局封禁。
  - `时长`: 封禁的小时数。如果留空，则为永久封禁。

- **`/管理 解封 [用户] [理由] [项目(可选)]`**
  - 解除用户的封禁。
  - `理由`: 本次解封操作的原因，将进行公开展示。
  - `项目`: 如果留空，则解除用户的全局封禁。

---

## 🛠️ 开发者信息

### 清理全局命令

如果您之前以全局模式运行过机器人，并希望清理掉所有服务器上残留的命令，可以运行一次性脚本 `cleanup_commands.py`。

1.  确保您的 `.env` 文件已配置好 `DISCORD_BOT_TOKEN`。
2.  运行 `python cleanup_commands.py`。
3.  脚本执行完毕后即可删除。

**注意**: 全局命令的更新可能需要长达一个小时才能在所有服务器上生效。


---

## 📜 许可证 (License)

本项目采用 **[Apache-2.0 with Commons Clause](LICENSE)** 许可协议。

以下是许可证核心条款的摘要，方便您快速理解。完整内容请查阅 [LICENSE](LICENSE) 文件。

<details>
<summary><strong>点击展开/折叠 许可证摘要 (中英对照)</strong></summary>

### Commons Clause (公共条款) 摘要

这是在 Apache 2.0 许可证之上附加的一个**核心限制条款**。

**核心限制：禁止销售**

在不限制 Apache 2.0 许可证中其他条件的情况下，本授权**不包含**，也**未授予**您**“销售”**本软件的权利。

就上述条款而言，“销售”是指为了获取费用或其他对价，向第三方提供其价值完全或主要源于本软件功能的产品或服务。这包括但不限于提供与本软件相关的托管或咨询/支持服务。

*   **软件 (Software)**: `discord-coupon-bot`
*   **许可证 (License)**: `Apache 2.0`
*   **许可方 (Licensor)**: `beijixingxing`

---

### Apache 2.0 许可证摘要

这是一个宽松的开源软件许可证，它允许您：

*   **自由使用**: 您可以免费地、在世界范围内、非独占地使用本软件。
*   **自由分发**: 您可以复制和分发本软件的原始或修改版本。
*   **自由修改**: 您可以修改本软件的源代码，并分发您的衍生作品。

同时，您需要遵守以下主要条件：

*   **保留声明**: 在分发软件时，您必须向接收者提供本许可证的副本，并保留原始的版权、专利、商标和归属声明。
*   **声明修改**: 如果您修改了文件，必须在文件中附上明确的声明。
*   **无担保**: 本软件按“原样”提供，不附带任何明示或暗示的保证。

</details>
