# Discord 兑换券机器人

一个功能强大且易于部署的 Discord 机器人，用于管理、分发和跟踪多个项目的兑换券。

## ✨ 功能特性

- **多项目管理**: 可同时创建和管理多个独立的兑换券项目。
- **灵活的兑换券系统**:
  - 管理员可通过上传 `.txt` 文件批量添加兑换券。
  - 自动防止重复的兑换券被添加。
- **完善的用户申领流程**:
  - 用户可通过 `/申领` 命令获取兑换券。
  - 可通过 `/库存` 命令查询指定项目剩余的兑换券数量。
- **强大的权限与设置**:
  - 基于 Discord 角色的管理员权限系统 (默认为 "管理组" 角色)。
  - 可为每个项目独立**开启/关闭**申领功能。
  - 可为每个项目独立设置**申领冷却时间**。
- **用户管理与审核**:
  - 管理员可对用户进行**全局**或**项目级**的封禁/解封。
  - 可设置封禁时长，支持永久封禁。
- **为生产环境设计**:
  - 使用 `SQLAlchemy` 和 `SQLite` 进行高效、异步的数据库操作。
  - 包含自动重连逻辑，确保机器人稳定运行。
  - 提供 `Dockerfile` 和 `docker-compose.yml`，支持一键式容器化部署。
  - 支持通过环境变量将命令限定在**指定服务器**注册，避免对非开发服务器的干扰。

---

## 🚀 快速开始

### 先决条件

- [Docker](https://www.docker.com/get-started) 和 [Docker Compose](https://docs.docker.com/compose/install/)
- 一个 Discord 机器人账号并获取其 **Token**
- 在您的 Discord 服务器中创建一个名为 **`管理组`** 的角色，并将其分配给您自己。

### 安装与配置

1.  **克隆或下载此项目**
    ```bash
    git clone https://github.com/your-username/discord-coupon-bot.git
    cd discord-coupon-bot
    ```

2.  **创建并配置 `.env` 文件**
    - 复制 `.env.example` 文件并重命名为 `.env`。
    - 打开 `.env` 文件并填入您的信息：
      ```env
      # 您的 Discord 机器人令牌
      DISCORD_BOT_TOKEN="在此处粘贴您的机器人令牌"

      # (推荐) 信任的服务器ID。如果设置此ID，命令将只在该服务器上即时注册。
      TRUSTED_GUILD_ID="在此处粘贴您的服务器ID"
      ```
    - **如何获取服务器 ID**: 在 Discord 中，右键点击您的服务器图标，选择“复制服务器 ID”。(您可能需要在用户设置 > 高级中开启“开发者模式”)

3.  **使用 Docker Compose 启动机器人**
    在项目根目录下运行以下命令：
    ```bash
    docker-compose up -d --build
    ```
    这将会构建镜像并在后台启动机器人。

4.  **查看日志** (可选)
    如果您想确认机器人是否成功启动，可以运行：
    ```bash
    docker-compose logs -f
    ```
    当您看到 `以 YourBotName#1234 的身份登录成功` 时，表示机器人已准备就绪。

---

## 🤖 命令列表

### 普通用户命令

- **`/库存 [项目]`**
  - 查询指定项目的可用兑换券数量。
  - `项目`: 要查询的项目名称 (有自动补全)。

- **`/申领 [项目]`**
  - 从指定的项目申领一张兑换券。
  - `项目`: 要申领的项目名称 (有自动补全)。
  - 机器人会将兑换券代码通过一条仅您可见的消息发送给您。

### 管理员命令 (需要 `管理组` 角色)

所有管理员命令都在 `/管理` 命令组下。

- **`/管理 创建项目 [名称]`**
  - 创建一个新的兑换券项目。

- **`/管理 删除项目 [项目]`**
  - **(危险操作)** 永久删除一个项目及其所有兑换券和封禁记录。操作前会有二次确认。

- **`/管理 添加兑换券 [项目] [文件]`**
  - 向指定项目批量添加兑换券。
  - `文件`: 一个 `.txt` 文件，每行包含一个兑换券代码。

- **`/管理 开关申领 [项目] [状态]`**
  - 为一个项目启用或禁用申领功能。
  - `状态`: `开启` 或 `关闭`。

- **`/管理 设置冷却 [项目] [小时]`**
  - 为一个项目设置申领冷却时间（单位：小时）。设置为 `0` 则无冷却。

- **`/管理 封禁 [用户] [原因] [项目(可选)] [时长(可选)]`**
  - 禁止一个用户申领兑换券。
  - `项目`: 如果留空，则为全局封禁。
  - `时长`: 封禁的小时数。如果留空，则为永久封禁。

- **`/管理 解封 [用户] [项目(可选)]`**
  - 解除用户的封禁。
  - `项目`: 如果留空，则解除用户的全局封禁。

---

## 🛠️ 开发者信息

### 清理全局命令

如果您之前以全局模式运行过机器人，并希望清理掉所有服务器上残留的命令，可以运行一次性脚本 `cleanup_commands.py`。

1.  确保您的 `.env` 文件已配置好 `DISCORD_BOT_TOKEN`。
2.  运行 `python cleanup_commands.py`。
3.  脚本执行完毕后即可删除。

**注意**: 全局命令的更新可能需要长达一个小时才能在所有服务器上生效。
